<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CFD Terminal — Chart + Trading UI</title>
<script src="https://unpkg.com/lightweight-charts@4.0.1/dist/lightweight-charts.standalone.production.js"></script>
<style>
/* (стили — те же, что были; сокращены для читаемости) */
:root{--bg-main:#0d1117;--panel:#0b0f14;--panel-2:#161b22;--border:#1a1f25;--muted:#a0a3a9;--text:#d1d4dc;--hover:rgba(255,255,255,0.06);--active:#2a323d}
*{box-sizing:border-box}html,body{height:100%;margin:0;background:var(--bg-main);color:var(--text);font-family:Inter,Arial,Helvetica,sans-serif}
.app{display:flex;flex-direction:column;height:100vh;}.workspace{display:flex;flex:1;min-height:0}
#chart-wrap{flex:7;display:flex;flex-direction:column;min-width:0}
#chart-toolbar{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;height:44px;background:var(--panel);border-bottom:1px solid var(--border)}
.tf-group{display:flex;gap:8px}
.tf-btn{padding:6px 10px;border-radius:8px;font-size:13px;color:var(--text);background:transparent;border:0;cursor:pointer;opacity:0.95}
.tf-btn:hover{background:var(--hover)}.tf-btn.active{background:var(--active);color:#fff}
#fullscreen-btn{padding:6px 10px;border-radius:8px;background:transparent;border:0;color:var(--muted);cursor:pointer}
#fullscreen-btn:hover{background:var(--hover);color:#fff}
#chart{flex:1;min-height:0}
#chart-footer{height:36px;background:var(--panel);border-top:1px solid var(--border);display:flex;align-items:center;justify-content:flex-end;padding:0 12px}
#utc-button{background:transparent;border:0;color:var(--text);padding:6px 12px;border-radius:6px;cursor:pointer}#utc-button:hover{background:var(--hover)}
#right{flex:3;background:var(--panel-2);border-left:1px solid var(--border);display:flex;flex-direction:column;min-width:260px;max-width:480px;overflow:hidden}
#right-header{display:flex;gap:8px;padding:10px;align-items:center;border-bottom:1px solid var(--border)}
#search{flex:1;background:#0e1117;border:1px solid #252930;padding:8px 10px;border-radius:8px;color:var(--text)}
#cat{background:#0e1117;border:1px solid #252930;padding:8px 10px;border-radius:8px;color:var(--text)}
#inst-list{overflow:auto;flex:1;padding-bottom:8px}
.inst-row{display:flex;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border);cursor:pointer}
.inst-row:hover{background:#1d242b}.inst-row.active{background:var(--active)}
/* TRADE PANEL */
#trade-area{border-top:1px solid var(--border);background:var(--panel);padding:10px}
.trade-tabs{display:flex;gap:10px;margin-bottom:10px}
.trade-tab{padding:8px 12px;border-radius:8px;background:transparent;cursor:pointer}.trade-tab:hover{background:var(--hover)}.trade-tab.active{background:var(--active);color:#fff}
.form-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
.form-row input, .form-row select{flex:1;padding:8px;border-radius:6px;border:1px solid #252930;background:#0e1117;color:var(--text)}
.form-row label{width:90px;color:var(--muted);font-size:13px}
.action-row{display:flex;gap:8px}
.buy-btn{flex:1;padding:10px;background:#197b5a;color:#fff;border-radius:8px;border:0;cursor:pointer}
.sell-btn{flex:1;padding:10px;background:#9b3e3e;color:#fff;border-radius:8px;border:0;cursor:pointer}
.positions{height:240px;background:var(--panel);border-top:1px solid var(--border);padding:12px;display:flex;flex-direction:column;gap:8px}
.placeholder{flex:1;display:flex;align-items:center;justify-content:center;color:#888;font-size:14px}
.small{font-size:13px;color:var(--muted)}
</style>
</head>
<body>
<div class="app">
  <div id="top"></div>
  <div class="workspace">
    <div id="chart-wrap">
      <div id="chart-toolbar">
        <div class="tf-group" id="tf-group">
          <button class="tf-btn" data-interval="1m">1m</button>
          <button class="tf-btn" data-interval="5m">5m</button>
          <button class="tf-btn" data-interval="15m">15m</button>
          <button class="tf-btn" data-interval="1h">1h</button>
          <button class="tf-btn" data-interval="4h">4h</button>
          <button class="tf-btn" data-interval="1d">1d</button>
          <button class="tf-btn" data-interval="1w">1w</button>
          <button class="tf-btn" data-interval="1M">1M</button>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <button id="fullscreen-btn" title="Fullscreen">⤢</button>
        </div>
      </div>
      <div id="chart"></div>
      <div id="chart-footer">
        <button id="utc-button">--:--:-- UTC+0</button>
      </div>
    </div>

    <div id="right">
      <div id="right-header">
        <input id="search" placeholder="Search..." />
        <select id="cat"><option value="all">All</option><option value="crypto">Crypto</option></select>
      </div>

      <div id="inst-list"></div>

      <div id="trade-area">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
          <div id="sel-instrument" style="font-weight:600">Select instrument</div>
          <div class="small">Market • Demo</div>
        </div>

        <div class="trade-tabs">
          <div class="trade-tab active" data-tab="market">Market</div>
          <div class="trade-tab" data-tab="limit">Limit/Stop</div>
        </div>

        <div id="trade-form">
          <div class="form-row">
            <select id="order-type"><option value="market">Market</option><option value="limit">Limit</option><option value="stop">Stop</option></select>
          </div>
          <div class="form-row">
            <label>Volume</label>
            <input id="order-volume" type="number" step="0.0001" value="0.001" />
          </div>
          <div class="form-row" id="price-row" style="display:none">
            <label>Price</label>
            <input id="order-price" type="number" step="0.0001" />
          </div>
          <div class="form-row">
            <label>SL</label>
            <input id="order-sl" type="number" step="0.0001" />
          </div>
          <div class="form-row">
            <label>TP</label>
            <input id="order-tp" type="number" step="0.0001" />
          </div>
          <div class="form-row">
            <input id="order-lev" type="number" step="1" value="1" />
          </div>

          <div class="action-row" style="margin-top:8px">
            <button class="sell-btn" id="btn-sell">Sell</button>
            <button class="buy-btn" id="btn-buy">Buy</button>
          </div>

          <div style="margin-top:10px" class="small">Tip: For limit/stop choose price and select Limit/Stop tab.</div>
        </div>
      </div>
    </div>
  </div>

  <div class="positions">
    <div style="display:flex; justify-content:space-between; gap:12px; align-items:center">
      <div style="font-weight:700">Positions</div>
      <div id="acc-info" class="small">Balance: —  Equity: —</div>
    </div>
    <div id="positions-list" class="placeholder">No open positions</div>
  </div>
</div>

<script>
/* ---------- chart init (same as before) ---------- */
const chartContainer = document.getElementById('chart');
const chart = LightweightCharts.createChart(chartContainer, {
  layout: { background: { color: '#0d1117' }, textColor: '#d1d4dc' },
  grid: { vertLines: { color: '#1a1f25' }, horzLines: { color: '#1a1f25' } },
  crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
  timeScale: { borderColor: '#485c7b' },
});
const candleSeries = chart.addCandlestickSeries();

/* ---------- state ---------- */
let currentInterval = '1h';
let currentSymbol = 'BTCUSDT';
let offsetMinutes = 0;
let tzLabel = 'UTC+0';
let latestPrices = {};

/* ---------- time formatting & UTC button (unchanged) ---------- */
const weekdays = ['Вс','Пн','Вт','Ср','Чт','Пт','Сб'];
const months = ['Янв','Фев','Мар','Апр','Май','Июн','Июл','Авг','Сен','Окт','Ноя','Дек'];
function formatCandleTime(tsSec, tf){
  const d = new Date((tsSec + offsetMinutes*60)*1000);
  const dayName = weekdays[d.getUTCDay()];
  const day = String(d.getUTCDate()).padStart(2,'0');
  const month = months[d.getUTCMonth()];
  const year = d.getUTCFullYear();
  const hh = String(d.getUTCHours()).padStart(2,'0');
  const mm = String(d.getUTCMinutes()).padStart(2,'0');
  if(tf === '1M'){ const first = new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), 1)); return `${weekdays[first.getUTCDay()]} 01 ${months[first.getUTCMonth()]} ${first.getUTCFullYear()}`; }
  if(tf === '1w'){ const dd = new Date((tsSec + offsetMinutes*60)*1000); const dow = dd.getUTCDay(); const monday = new Date(dd); monday.setUTCDate(dd.getUTCDate() - ((dow + 6) % 7)); return `${weekdays[monday.getUTCDay()]} ${String(monday.getUTCDate()).padStart(2,'0')} ${months[monday.getUTCMonth()]} ${monday.getUTCFullYear()}`; }
  if(tf === '1d') return `${dayName} ${day} ${month} ${year}`;
  return `${dayName} ${day} ${month} ${year} ${hh}:${mm}`;
}
chart.applyOptions({ localization: { timeFormatter: (t)=>formatCandleTime(t, currentInterval) }, timeScale:{ timeVisible:true, secondsVisible:false }});
function updateTimeFormatter(){ chart.applyOptions({ localization: { timeFormatter: (t)=>formatCandleTime(t, currentInterval) } }); }
async function loadKlines(symbol=currentSymbol, interval=currentInterval){
  try{ const url=`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=600`; const res=await fetch(url); const raw=await res.json(); const candles=raw.map(c=>({time:c[0]/1000, open:+c[1], high:+c[2], low:+c[3], close:+c[4]})); candleSeries.setData(candles); return; }catch(e){ console.warn(e);}
  const now = Math.floor(Date.now()/1000); const candles = Array.from({length:600},(_,i)=>{const t=now-(600-i)*3600;const o=20000+Math.sin(i/10)*200;const c=o+Math.sin(i/5)*50;return {time:t,open:o,high:o+100,low:o-100,close:c}}); candleSeries.setData(candles); return;
  try{
    const res = await fetch(`/api/history?symbol=${symbol}&interval=${interval}&limit=600`);
    const data = await res.json();
    if(data.s === 'ok') {
      candleSeries.setData(data.candles);
    } else {
      console.warn('kline error', data);
    }
  }catch(e){ console.warn(e); }
}
loadKlines();

/* ---------- TF buttons ---------- */
const tfBtns = document.querySelectorAll('.tf-btn');
tfBtns.forEach(btn=>{
  if(btn.dataset.interval === currentInterval) btn.classList.add('active');
  btn.addEventListener('click', async ()=>{
    currentInterval = btn.dataset.interval;
    tfBtns.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    await loadKlines(currentSymbol, currentInterval);
    chart.applyOptions({ timeScale: { timeVisible:true, secondsVisible: currentInterval === '1m' }});
    updateTimeFormatter();
  });
});

/* ---------- fullscreen ---------- */
const fsBtn = document.getElementById('fullscreen-btn');
let isFull=false;
fsBtn.addEventListener('click', ()=> {
  isFull = !isFull;
  const chartWrap = document.getElementById('chart-wrap');
  const right = document.getElementById('right');
  const positions = document.getElementById('positions');
  if(isFull){ chartWrap.classList.add('chart-fullscreen'); right.style.display='none'; positions.style.display='none'; fsBtn.textContent='⤡'; }
  else { chartWrap.classList.remove('chart-fullscreen'); right.style.display='flex'; positions.style.display='block'; fsBtn.textContent='⤢'; }
  setTimeout(()=>chart.resize(chartContainer.clientWidth, chartContainer.clientHeight),120);
});
window.addEventListener('resize', ()=> setTimeout(()=>chart.resize(chartContainer.clientWidth, chartContainer.clientHeight),50));

/* ---------- instruments list & search ---------- */
const instruments = ['BTCUSDT','ETHUSDT','BNBUSDT','XRPUSDT','ADAUSDT'];
const instListEl = document.getElementById('inst-list');
const searchEl = document.getElementById('search');
const selInstrumentEl = document.getElementById('sel-instrument');

function renderInstList(filter=''){
  instListEl.innerHTML='';
  const arr = instruments.filter(s => s.toLowerCase().includes(filter.toLowerCase()));
  arr.forEach(sym=>{
    const row = document.createElement('div');
    row.className='inst-row';
    row.dataset.sym = sym;
    row.innerHTML = `<div>${sym}</div><div class="price">—</div>`;
    row.addEventListener('click', async()=>{
      document.querySelectorAll('.inst-row').forEach(r=>r.classList.remove('active'));
      row.classList.add('active');
      currentSymbol = sym;
      selInstrumentEl.textContent = sym;
      await loadKlines(currentSymbol, currentInterval);
    });
    instListEl.appendChild(row);
  });
}
renderInstList('');
searchEl.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') renderInstList(searchEl.value.trim()); });
searchEl.addEventListener('input', ()=> renderInstList(searchEl.value.trim()));

/* update prices in instrument list */
async function refreshPrices(){
  document.querySelectorAll('.inst-row').forEach(async row=>{
    const sym = row.dataset.sym;
    try{
      const res = await fetch(`/api/history?symbol=${sym}&interval=1m&limit=1`);
      const d = await res.json();
      if(d.s === 'ok' && d.candles && d.candles.length) {
        const last = d.candles[d.candles.length-1];
        row.querySelector('.price').textContent = last.close.toFixed(2);
        latestPrices[sym] = last.close;
      }
    }catch(e){}
  });
}
refreshPrices(); setInterval(refreshPrices, 8000);

/* ---------- TRADE FORM logic (calls server APIs) ---------- */
const typeEl = document.getElementById('order-type');
const volEl = document.getElementById('order-volume');
const priceEl = document.getElementById('order-price');
const slEl = document.getElementById('order-sl');
const tpEl = document.getElementById('order-tp');
const levEl = document.getElementById('order-lev');
const btnBuy = document.getElementById('btn-buy');
const btnSell = document.getElementById('btn-sell');
const priceRow = document.getElementById('price-row');

typeEl.addEventListener('change', ()=> {
  priceRow.style.display = (typeEl.value === 'market') ? 'none' : 'flex';
});

async function placeOrder(side) {
  const payload = {
    symbol: currentSymbol,
    side: side,
    type: typeEl.value,
    volume: parseFloat(volEl.value),
    price: priceEl.value ? parseFloat(priceEl.value) : undefined,
    sl: slEl.value ? parseFloat(slEl.value) : undefined,
    tp: tpEl.value ? parseFloat(tpEl.value) : undefined,
  };
  try {
    const data = await res.json();
    if(data.error) return alert('Order error: ' + data.error);
    await refreshPositions();
    alert('Order placed');
  } catch (e) {
    alert('Order failed: ' + e.message);
  }
}

btnBuy.addEventListener('click', ()=> placeOrder('buy'));
btnSell.addEventListener('click', ()=> placeOrder('sell'));

/* ---------- positions list & account ---------- */
const positionsListEl = document.getElementById('positions-list');
const accInfoEl = document.getElementById('acc-info');

async function refreshPositions(){
  try{
    const [ordersRes, accRes] = await Promise.all([fetch('/api/orders'), fetch('/api/account')]);
    const orders = await ordersRes.json();
    const acc = await accRes.json();
    // show account balance/equity
    accInfoEl.textContent = `Balance: ${(+acc.balance).toFixed(2)}  Equity: ${(+acc.equity).toFixed(2)}`;
    // show open positions
    const open = orders.filter(o => o.status === 'open');
    if(open.length === 0){
      positionsListEl.innerHTML = '<div class="placeholder">No open positions</div>';
    } else {
      positionsListEl.innerHTML = '';
      open.forEach(o=>{
        const div = document.createElement('div');
        div.style.display = 'flex';
        div.style.justifyContent = 'space-between';
        div.style.padding = '8px';
        div.style.borderBottom = '1px solid var(--border)';
        const price = o.currentPrice ? Number(o.currentPrice).toFixed(2) : '—';
        const upnl = o.unrealizedPnl ? Number(o.unrealizedPnl).toFixed(2) : '0.00';
        div.innerHTML = `<div><b>${o.symbol}</b> ${o.side.toUpperCase()} ${o.volume}<br/><span class="small">entry ${Number(o.entryPrice).toFixed(2)}  sl:${o.sl||'—'} tp:${o.tp||'—'}</span></div><div style="text-align:right"><div>${price}</div><div style="color:${o.unrealizedPnl>=0? '#58d68d':'#ff7b7b'}">${upnl}</div><button data-id="${o.id}" style="margin-top:6px">Close</button></div>`;
        positionsListEl.appendChild(div);
        div.querySelector('button').addEventListener('click', async ()=>{
          const id = div.querySelector('button').dataset.id;
          await refreshPositions();
        });
      });
    }
  }catch(e){ console.warn(e); }
}
setInterval(refreshPositions, 3000);
refreshPositions();

/* ---------- timezone menu ---------- */
const tzPresets = [
  {label:'UTC−5 — New York', offset:-300},{label:'UTC+0 — London', offset:0},{label:'UTC+1 — Madrid', offset:60},{label:'UTC+2 — Helsinki', offset:120},{label:'UTC+3 — Qatar', offset:180},{label:'UTC+4 — Dubai', offset:240},{label:'UTC+7 — Bangkok', offset:420},{label:'UTC+8 — Singapore', offset:480},{label:'UTC+9 — Tokyo', offset:540},{label:'UTC+12 — Auckland', offset:720}
];
utcBtn.addEventListener('click', ()=>{
  const menu = document.createElement('div');
  menu.style.position='absolute'; menu.style.right='12px'; menu.style.bottom='44px'; menu.style.background='var(--panel-2)'; menu.style.border='1px solid var(--border)'; menu.style.padding='6px'; menu.style.borderRadius='8px'; menu.style.boxShadow='0 8px 20px rgba(0,0,0,0.6)'; menu.style.zIndex=2000;
  tzPresets.forEach(tz=>{
    const it = document.createElement('div'); it.textContent = tz.label; it.style.padding='6px 10px'; it.style.cursor='pointer'; it.style.color='var(--text)';
    it.addEventListener('click', ()=>{ offsetMinutes = tz.offset; tzLabel = tz.label.split(' ')[0]; updateUtcDisplay(); updateTimeFormatter(); document.body.removeChild(menu); });
    it.addEventListener('mouseover', ()=> it.style.background = 'var(--hover)'); it.addEventListener('mouseout', ()=> it.style.background = 'transparent');
    menu.appendChild(it);
  });
  document.body.appendChild(menu);
  const removeMenu = (ev)=>{ if(!menu.contains(ev.target) && ev.target !== utcBtn){ document.body.removeChild(menu); document.removeEventListener('click', removeMenu); } };
  document.addEventListener('click', removeMenu);
});

/* expose debug */
window._debug = { loadKlines, refreshPositions, latestPrices };
</script>
</body>
</html>
<script src="fix-timezone.js"></script>
<script src="fix-orders-panel.js"></script>
